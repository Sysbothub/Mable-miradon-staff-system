<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>HQ TERMINAL</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: #020617; color: #f1f5f9; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
        .glass { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(10px); border: 1px solid #1e293b; }
        .attachment-preview { max-width: 250px; border-radius: 8px; margin-top: 5px; border: 1px solid #334155; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #3b82f6; border-radius: 10px; }
        .hidden { display: none !important; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <div id="login-view" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-950">
        <div class="glass p-8 rounded-2xl w-full max-w-sm text-center">
            <h1 class="text-2xl font-black text-blue-500 mb-6 italic">HQ TERMINAL</h1>
            
            <div id="login-section">
                <input type="text" id="l-user" placeholder="IDENTIFIER" class="w-full bg-slate-900 border border-slate-800 p-3 rounded-lg mb-4 outline-none text-xs">
                <input type="password" id="l-pass" placeholder="SECURITY KEY" class="w-full bg-slate-900 border border-slate-800 p-3 rounded-lg mb-2 outline-none text-xs">
                <div class="text-right mb-6">
                    <button onclick="toggleRecovery(true)" class="text-[10px] text-slate-500 hover:text-blue-400 uppercase font-bold transition">Key Recovery</button>
                </div>
                <button id="login-btn" onclick="doLogin()" class="w-full bg-blue-600 p-3 rounded-lg font-bold uppercase text-xs">Establish Link</button>
            </div>

            <div id="recovery-section" class="hidden">
                <p class="text-[10px] text-slate-400 mb-4 uppercase font-bold italic">Terminal Recovery: Discord ID Required</p>
                <input type="text" id="r-discord" placeholder="DISCORD ID" class="w-full bg-slate-900 border border-slate-800 p-3 rounded-lg mb-6 outline-none text-xs">
                <button onclick="requestRecovery()" class="w-full bg-amber-600 p-3 rounded-lg font-bold uppercase text-xs mb-4">Send New Key</button>
                <button onclick="toggleRecovery(false)" class="text-[10px] text-slate-500 hover:text-white uppercase font-bold transition">Return</button>
            </div>
        </div>
    </div>

    <header class="h-16 glass flex items-center justify-between px-8 z-40">
        <div class="flex items-center space-x-6">
            <span class="font-black text-blue-500 italic">HQ TERMINAL</span>
            <button onclick="showView('chat')" class="text-xs font-bold uppercase hover:text-blue-400 transition">Tickets</button>
            <button id="nav-admin" onclick="showView('admin')" class="hidden text-xs font-bold uppercase text-amber-500 hover:text-amber-400 transition">Admin Console</button>
        </div>
        <div class="flex items-center space-x-4">
            <button onclick="selfReset()" class="text-[10px] text-slate-500 hover:text-white border border-slate-800 px-2 py-1 rounded transition uppercase">Reset My Key</button>
            <button onclick="doLogout()" class="text-xs text-red-500 border border-red-500/30 px-3 py-1 rounded hover:bg-red-600 hover:text-white transition uppercase font-bold italic">DC</button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <div id="view-chat" class="flex flex-1 overflow-hidden">
            <aside id="thread-list" class="w-80 glass border-t-0 border-l-0 overflow-y-auto"></aside>
            <main class="flex-1 flex flex-col bg-slate-950">
                <div class="h-12 glass border-x-0 border-t-0 flex items-center justify-between px-6">
                    <span id="active-tag" class="text-xs font-bold text-slate-500 uppercase italic">Idle...</span>
                    <button onclick="closeTicket()" class="text-[10px] bg-red-600 px-2 py-1 rounded font-bold uppercase">Archive & Close</button>
                </div>
                <div id="chat-box" class="flex-1 overflow-y-auto p-6 space-y-4 flex flex-col"></div>
                
                <div class="p-4 glass border-x-0 border-b-0">
                    <div id="file-indicator" class="hidden text-[10px] text-blue-400 mb-2 font-bold uppercase italic">ðŸ“Ž Ready: Attachment Staged</div>
                    <form onsubmit="sendReply(event)" class="flex space-x-4 items-center">
                        <input type="file" id="file-input" class="hidden" onchange="handleFileSelect()">
                        <button type="button" onclick="document.getElementById('file-input').click()" class="bg-slate-800 p-3 rounded-xl hover:text-blue-500 transition">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
                        </button>
                        <input type="text" id="msg-input" placeholder="Secure Message..." class="flex-1 bg-slate-900 border border-slate-800 p-3 rounded-xl outline-none text-sm">
                        <button class="bg-blue-600 px-6 py-3 rounded-xl font-bold uppercase text-xs">Transmit</button>
                    </form>
                </div>
            </main>
        </div>

        <div id="view-admin" class="hidden flex-1 overflow-y-auto p-10 space-y-8">
            <div class="grid grid-cols-2 gap-8">
                <div class="glass p-6 rounded-xl">
                    <h2 class="text-blue-500 font-bold mb-4 uppercase text-xs italic underline">Provision Staff</h2>
                    <input type="text" id="add-user" placeholder="USERNAME" class="w-full bg-slate-900 border border-slate-800 p-3 rounded text-xs mb-2 outline-none">
                    <input type="text" id="add-discord" placeholder="DISCORD ID" class="w-full bg-slate-900 border border-slate-800 p-3 rounded text-xs mb-4 outline-none">
                    <label class="flex items-center space-x-2 mb-6 text-[10px] uppercase font-bold text-slate-500">
                        <input type="checkbox" id="add-is-admin" class="w-4 h-4 rounded border-slate-800 bg-slate-900"> <span>Elevated Permissions (Admin)</span>
                    </label>
                    <button onclick="addStaff()" class="w-full bg-blue-600 text-[10px] font-bold py-3 rounded uppercase">Authorize Staff Member</button>
                </div>
                <div class="glass p-6 rounded-xl overflow-hidden flex flex-col">
                    <h2 class="text-amber-500 font-bold mb-4 uppercase text-xs italic underline">Operational Staff Registry</h2>
                    <div id="staff-stats" class="space-y-2 overflow-y-auto flex-1"></div>
                </div>
            </div>
            
            <div class="glass p-6 rounded-xl">
                <h2 class="text-red-500 font-bold mb-4 uppercase text-xs italic underline">Global Broadcast (All Bot Owners)</h2>
                <div class="flex space-x-4">
                    <input type="text" id="bulk-msg" placeholder="Broadcast Content..." class="flex-1 bg-slate-900 border border-slate-800 p-3 rounded outline-none text-xs">
                    <button onclick="sendBulk()" class="bg-red-600 px-6 py-3 rounded font-bold uppercase text-[10px]">Execute Global DM</button>
                </div>
            </div>

            <div class="glass p-6 rounded-xl">
                <h2 class="text-blue-400 font-bold mb-4 uppercase text-xs italic underline">Bot Fleet: Connected Servers</h2>
                <div id="srv-list" class="grid grid-cols-3 gap-4"></div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let activeId = null;
        let threadStore = {};
        let selectedFile = null;

        async function req(url, method = 'GET', body = null) {
            const res = await fetch(url, { 
                method, 
                headers: { 'Content-Type': 'application/json' }, 
                body: body ? JSON.stringify(body) : null 
            });
            if (res.status === 401 && !url.includes('/api/login')) {
                document.getElementById('login-view').classList.remove('hidden');
                return { error: 'Unauthorized' };
            }
            return res.json();
        }

        async function doLogin() {
            const btn = document.getElementById('login-btn');
            btn.disabled = true; btn.innerText = "AUTHENTICATING...";
            const res = await fetch('/api/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    username: document.getElementById('l-user').value, 
                    password: document.getElementById('l-pass').value 
                })
            });
            if (res.ok) { window.location.reload(); } else { alert("ACCESS DENIED"); btn.disabled = false; btn.innerText = "Establish Link"; }
        }

        function doLogout() {
            document.cookie = "connect.sid=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
            window.location.reload();
        }

        function toggleRecovery(show) {
            document.getElementById('login-section').classList.toggle('hidden', show);
            document.getElementById('recovery-section').classList.toggle('hidden', !show);
        }

        async function requestRecovery() {
            const res = await req('/api/public/request-reset', 'POST', { discordId: document.getElementById('r-discord').value });
            if(res.success) { alert("New Key Dispatched to Discord."); toggleRecovery(false); }
        }

        async function selfReset() {
            if(confirm("Regenerate your security key?")) {
                const res = await req('/api/staff/self-reset', 'POST');
                if(res.success) alert("Key rotated. Check your Discord DMs.");
            }
        }

        function showView(v) {
            document.getElementById('view-chat').classList.toggle('hidden', v !== 'chat');
            document.getElementById('view-admin').classList.toggle('hidden', v !== 'admin');
            if (v === 'admin') loadAdminData();
        }

        async function loadThreads() {
            const data = await req('/api/threads');
            if(!data || data.error) return;
            const list = document.getElementById('thread-list');
            list.innerHTML = '';
            data.forEach(t => {
                threadStore[t._id] = t;
                const d = document.createElement('div');
                d.className = `p-4 border-b border-slate-900 cursor-pointer hover:bg-slate-900 transition ${activeId === t._id ? 'bg-slate-900 border-l-4 border-blue-500' : ''}`;
                d.innerHTML = `<div class="font-bold text-xs">${t.userTag}</div><div class="text-[9px] text-slate-500 uppercase">${t.botName}</div>`;
                d.onclick = () => { activeId = t._id; renderChat(); loadThreads(); };
                list.appendChild(d);
            });
        }

        function renderChat() {
            const box = document.getElementById('chat-box');
            box.innerHTML = '';
            if (!activeId || !threadStore[activeId]) return;
            document.getElementById('active-tag').innerText = threadStore[activeId].userTag;
            threadStore[activeId].messages.forEach(m => {
                const d = document.createElement('div');
                d.className = `max-w-[75%] p-3 rounded-xl text-[11px] ${m.fromBot ? 'bg-blue-600 self-end font-bold' : 'bg-slate-800 self-start'}`;
                let html = `<div>${m.content}</div>`;
                if (m.attachments) m.attachments.forEach(url => html += `<img src="${url}" class="attachment-preview" onclick="window.open('${url}')">`);
                d.innerHTML = html;
                box.appendChild(d);
            });
            box.scrollTop = box.scrollHeight;
        }

        async function loadAdminData() {
            const stats = await req('/api/admin/stats');
            const srvs = await req('/api/admin/servers');
            if(!stats || stats.error) return;
            
            document.getElementById('staff-stats').innerHTML = stats.map(s => `
                <div class="flex items-center justify-between border-b border-slate-800 py-2">
                    <div class="flex flex-col text-[10px]">
                        <span class="font-bold text-blue-400">${s.username} ${s.isAdmin ? '[ADMIN]' : ''}</span>
                        <span class="text-slate-500">CLOSED: ${s.ticketsClosed} | REPLIES: ${s.repliesSent}</span>
                    </div>
                    <div class="flex space-x-1">
                        <button onclick="adminResetKey('${s._id}')" class="text-[8px] border border-blue-500 px-2 py-1 rounded">RESET</button>
                        <button onclick="deleteStaff('${s._id}')" class="text-[8px] border border-red-500 px-2 py-1 rounded">DEL</button>
                    </div>
                </div>
            `).join('');

            document.getElementById('srv-list').innerHTML = srvs.map(s => `
                <div class="glass p-3 rounded-lg text-[10px]">
                    <div class="font-bold text-blue-400 truncate">${s.name}</div>
                    <div class="text-slate-500 mb-2">${s.members} Members | via ${s.botName}</div>
                    <div class="flex space-x-1">
                        <button onclick="createInv('${s.id}', '${s.botId}')" class="bg-blue-600 px-2 py-1 rounded font-bold uppercase">Invite</button>
                        <button onclick="leaveSrv('${s.id}', '${s.botId}')" class="bg-red-600 px-2 py-1 rounded font-bold uppercase">Leave</button>
                        <button onclick="dmOwner('${s.id}', '${s.botId}')" class="bg-slate-700 px-2 py-1 rounded font-bold uppercase">DM</button>
                    </div>
                </div>
            `).join('');
        }

        async function addStaff() {
            const res = await req('/api/admin/staff/add', 'POST', { 
                username: document.getElementById('add-user').value, 
                discordId: document.getElementById('add-discord').value, 
                adminStatus: document.getElementById('add-is-admin').checked 
            });
            if(res.success) { alert("Staff Authorized."); loadAdminData(); }
        }

        async function deleteStaff(staffId) { if (confirm("Revoke access?")) { await req('/api/admin/staff/delete', 'POST', { staffId }); loadAdminData(); } }
        async function adminResetKey(staffId) { if (confirm("Force Key Reset?")) await req('/api/admin/staff/reset-password', 'POST', { staffId }); }
        async function createInv(serverId, botId) { const res = await req('/api/admin/create-invite', 'POST', { serverId, botId }); if (res.url) prompt("Invite URL:", res.url); }
        async function leaveSrv(serverId, botId) { if (confirm("Disconnect Bot?")) { await req('/api/admin/leave-server', 'POST', { serverId, botId }); loadAdminData(); } }
        async function dmOwner(serverId, botId) { const message = prompt("Owner Message:"); if (message) await req('/api/admin/dm-owner', 'POST', { serverId, botId, message }); }
        
        async function sendBulk() {
            const message = document.getElementById('bulk-msg').value;
            if (message && confirm("Confirm global broadcast to ALL owners?")) {
                const res = await req('/api/admin/bulk-message', 'POST', { message });
                alert(`Broadcast Successful. Targets: ${res.sentTo}`);
                document.getElementById('bulk-msg').value = '';
            }
        }

        function handleFileSelect() {
            const file = document.getElementById('file-input').files[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                selectedFile = { base64: e.target.result, name: file.name };
                document.getElementById('file-indicator').classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }

        async function sendReply(event) {
            event.preventDefault();
            const content = document.getElementById('msg-input').value;
            if (!activeId) return;
            await req('/api/reply', 'POST', { threadId: activeId, content, fileBase64: selectedFile?.base64, fileName: selectedFile?.name });
            document.getElementById('msg-input').value = '';
            selectedFile = null;
            document.getElementById('file-indicator').classList.add('hidden');
        }

        async function closeTicket() {
            if (activeId && confirm("Archive and close this session?")) {
                await req('/api/close-thread', 'POST', { threadId: activeId });
                activeId = null; loadThreads(); renderChat();
            }
        }

        socket.on('new_message', (d) => {
            if (threadStore[d.threadId]) {
                threadStore[d.threadId].messages.push(d);
                if (activeId === d.threadId) renderChat();
            } else loadThreads();
        });

        // INIT TERMINAL
        (async () => {
            const data = await req('/api/threads');
            if(!data.error) {
                document.getElementById('login-view').classList.add('hidden');
                loadThreads();
                const adminStats = await req('/api/admin/stats');
                if (!adminStats.error) document.getElementById('nav-admin').classList.remove('hidden');
            }
        })();
    </script>
</body>
</html>
