<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body{background:#020617;color:white;font-family:monospace} 
        input, select, textarea{background:#0f172a;border:1px solid #334155;padding:5px;width:100%;color:white;outline:none}
        input:focus, select:focus, textarea:focus{border-color:#6366f1}
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
    </style>
</head>
<body class="p-6 h-screen flex flex-col overflow-hidden">
    <nav class="mb-4 flex justify-between items-center shrink-0">
        <span class="font-bold text-amber-500 text-lg">MIRAIDON TRADE SERVICES / ADMIN</span>
        <a href="/staff/dashboard.html" class="text-xs text-slate-400 hover:text-white border border-slate-700 px-3 py-1 rounded">BACK TO DASHBOARD</a>
    </nav>
    
    <div class="flex-1 overflow-y-auto space-y-6 pr-2">
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="p-4 border border-indigo-900 rounded bg-slate-900/50">
                <h2 class="text-indigo-400 font-bold mb-3 border-b border-indigo-900 pb-1">LICENSE ACTIVATION</h2>
                <div class="grid grid-cols-2 gap-2 mb-2">
                    <input id="lk" placeholder="License Key">
                    <input id="ld" placeholder="Discord User ID">
                </div>
                <input id="li" placeholder="Instance ID / HWID" class="mb-2">
                <div class="grid grid-cols-2 gap-2 mb-2">
                    <input id="sn" placeholder="Server Name">
                    <input id="sid" placeholder="Server ID">
                </div>
                <div class="grid grid-cols-2 gap-2 mb-2">
                    <select id="dur"><option>30 Days</option><option>90 Days</option><option>365 Days</option><option>Lifetime</option></select>
                    <select id="type"><option>Premium Subscription</option><option>Professor Mable Rental</option></select>
                </div>
                <button onclick="lic()" class="w-full bg-indigo-600 hover:bg-indigo-500 p-2 rounded font-bold text-xs mt-1 transition">ACTIVATE LICENSE</button>
            </div>

            <div class="space-y-6">
                <div class="p-4 border border-amber-900 rounded bg-slate-900/50">
                    <h2 class="text-amber-400 font-bold mb-2 flex justify-between">STAFF TEAM <button onclick="load()" class="text-[10px] text-slate-500 hover:text-white">REFRESH</button></h2>
                    <div id="staff" class="h-24 overflow-y-auto mb-2 text-xs border border-slate-800 p-2 rounded bg-slate-950"></div>
                    <div class="flex gap-2">
                        <input id="su" placeholder="Username" class="w-1/3">
                        <input id="sd" placeholder="Discord ID" class="w-1/3">
                        <button onclick="addS()" class="bg-amber-600 hover:bg-amber-500 w-1/3 rounded font-bold text-xs">ADD</button>
                    </div>
                    <label class="text-[10px] text-slate-400 flex items-center gap-2 mt-1"><input type="checkbox" id="sa" style="width:auto"> Grant Admin</label>
                </div>

                <div class="p-4 border border-blue-900 rounded bg-slate-900/50">
                    <h2 class="text-blue-400 font-bold mb-2">MANUAL TICKET / DM</h2>
                    <input id="md-id" placeholder="Target Discord User ID" class="mb-2">
                    <div class="flex gap-2">
                        <input id="md-msg" placeholder="Opening Message...">
                        <button onclick="openTicket()" class="bg-blue-600 hover:bg-blue-500 w-24 rounded font-bold text-xs">OPEN</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="p-4 border border-pink-900 rounded bg-slate-900/50">
                <h2 class="text-pink-400 font-bold mb-2">FAQ EDITOR</h2>
                <div class="flex gap-2 mb-2">
                    <input id="fq" placeholder="Question">
                    <button onclick="faq()" class="bg-pink-600 hover:bg-pink-500 w-24 rounded font-bold text-xs">ADD</button>
                </div>
                <textarea id="fa" placeholder="Answer" class="h-16"></textarea>
            </div>

            <div class="p-4 border border-red-900 rounded bg-slate-900/50">
                <h2 class="text-red-400 font-bold mb-2">GLOBAL BROADCAST</h2>
                <p class="text-[10px] text-slate-400 mb-2">Sends a DM to the owner of every server the bot is in.</p>
                <div class="flex gap-2">
                    <input id="bm" placeholder="Message...">
                    <button onclick="broadcast()" class="bg-red-600 hover:bg-red-500 w-32 rounded font-bold text-xs">SEND ALL</button>
                </div>
            </div>
        </div>

        <div class="p-4 border border-slate-700 rounded bg-slate-900/50">
            <h2 class="text-slate-300 font-bold mb-4 border-b border-slate-700 pb-2">ACTIVE FLEET & SERVERS</h2>
            <div id="server-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2 max-h-64 overflow-y-auto">
                <div class="text-center text-slate-500 col-span-full py-4">Loading Servers...</div>
            </div>
        </div>

    </div>

    <script>
        const req = async (u,m='GET',b) => (await fetch(u,{method:m,headers:{'Content-Type':'application/json'},body:b?JSON.stringify(b):null})).json();
        
        async function load() {
            // Load Staff
            const staff = await req('/api/admin/stats');
            document.getElementById('staff').innerHTML = staff.map(s => `
                <div class="flex justify-between items-center p-1 border-b border-slate-800 last:border-0">
                    <span>${s.username} ${s.isAdmin?'(A)':''} <span class="text-slate-500 ml-2">â˜… ${(s.ratingSum/s.ratingCount||0).toFixed(1)}</span></span>
                    <button onclick="delS('${s._id}')" class="text-red-500 font-bold hover:text-red-400">âœ•</button>
                </div>
            `).join('');

            // Load Servers
            const servers = await req('/api/admin/servers');
            const sList = document.getElementById('server-list');
            
            if (servers.length === 0) {
                sList.innerHTML = '<div class="text-center text-slate-500 col-span-full">No active servers found.</div>';
            } else {
                sList.innerHTML = servers.map(s => `
                    <div class="p-3 bg-slate-950 border border-slate-800 rounded flex flex-col justify-between group hover:border-slate-600 transition">
                        <div>
                            <div class="font-bold text-xs truncate text-white" title="${s.name}">${s.name}</div>
                            <div class="text-[10px] text-slate-500 flex justify-between mt-1">
                                <span>ðŸ‘¥ ${s.members}</span>
                                <span class="text-indigo-400">ðŸ¤– ${s.botName}</span>
                            </div>
                        </div>
                        <div class="flex gap-1 mt-3 opacity-50 group-hover:opacity-100 transition">
                            <button onclick="mkInv('${s.id}','${s.botId}')" class="flex-1 bg-blue-900/50 hover:bg-blue-600 text-blue-200 rounded py-1 text-[9px] font-bold">LINK</button>
                            <button onclick="dmOwn('${s.id}','${s.botId}')" class="flex-1 bg-amber-900/50 hover:bg-amber-600 text-amber-200 rounded py-1 text-[9px] font-bold">OWNER</button>
                            <button onclick="leave('${s.id}','${s.botId}')" class="flex-1 bg-red-900/50 hover:bg-red-600 text-red-200 rounded py-1 text-[9px] font-bold">LEAVE</button>
                        </div>
                    </div>
                `).join('');
            }
        }

        // --- ACTIONS ---
        async function lic() { 
            const btn = event.target; btn.innerText="..."; btn.disabled=true;
            try {
                await req('/api/admin/license/activate','POST',{
                    license_key: document.getElementById('lk').value,
                    discord_id: document.getElementById('ld').value,
                    instance_name: document.getElementById('li').value,
                    server_name: document.getElementById('sn').value,
                    server_id: document.getElementById('sid').value,
                    type: document.getElementById('type').value,
                    duration: document.getElementById('dur').value,
                    channel_id: '000'
                }); 
                alert("Activated & User Notified");
                ['lk','ld','li','sn','sid'].forEach(i=>document.getElementById(i).value='');
            } catch(e){ alert("Error"); }
            btn.innerText="ACTIVATE LICENSE"; btn.disabled=false;
        }

        async function addS() { await req('/api/admin/staff/add','POST',{username:document.getElementById('su').value,discordId:document.getElementById('sd').value,adminStatus:document.getElementById('sa').checked}); load(); }
        async function delS(id) { if(confirm("Delete staff?")) { await req('/api/admin/staff/delete','POST',{staffId:id}); load(); } }
        async function faq() { await req('/api/admin/faq/add','POST',{question:document.getElementById('fq').value,answer:document.getElementById('fa').value}); alert("Added"); }
        
        // NEW: MANUAL TICKET FUNCTION
        async function openTicket() {
            const id = document.getElementById('md-id').value;
            const msg = document.getElementById('md-msg').value;
            if(!id || !msg) return alert("Missing ID or Message");
            
            const btn = event.target; btn.innerText = "..."; btn.disabled = true;
            try {
                await req('/api/admin/manual-dm', 'POST', { discordId: id, content: msg });
                alert("Ticket Opened!");
                document.getElementById('md-id').value = '';
                document.getElementById('md-msg').value = '';
            } catch(e) { alert("Failed. Check ID."); }
            btn.innerText = "OPEN"; btn.disabled = false;
        }

        async function mkInv(sid, bid) { const r = await req('/api/admin/create-invite', 'POST', { serverId: sid, botId: bid }); if(r.url) prompt("Invite URL:", r.url); else alert("Bot lacks permission."); }
        async function leave(sid, bid) { if(confirm("Force bot to leave server?")) { await req('/api/admin/leave-server', 'POST', { serverId: sid, botId: bid }); load(); } }
        async function dmOwn(sid, bid) { const m = prompt("Message to Server Owner:"); if(m) await req('/api/admin/dm-owner', 'POST', { serverId: sid, botId: bid, message: m }); }
        
        async function broadcast() {
            const msg = document.getElementById('bm').value;
            if(msg && confirm("WARNING: Send to ALL server owners?")) {
                const res = await req('/api/admin/bulk-message', 'POST', { message: msg });
                alert(`Broadcast sent to ${res.sentTo} owners.`);
            }
        }

        load();
    </script>
</body>
</html>
